<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"
    />
    <title>Mall</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/vant@4.9.6/lib/index.css"
    />
    <style>
      html, body, #app, #container {
        height: 100%;
      }
      :root:root {
        --van-card-price-color: var(--van-submit-bar-price-color);
        --van-card-background: #fff;
      }
      body {
        font-size: 12px;
        background-color: var(--van-gray-1);
      }
      .product-swipe img {
        width: 100%;
        display: block;
      }
      .divider {
        border-color: #000;
        width: 200px;
        margin: 0 auto;
      }
      .category-grid-item .van-grid-item__content {
        background-color: transparent;
      }
    </style>
  </head>

  <body>
    <!-- 商品分类页 START -->
    <template id="categoryListPage">
      <van-sticky :offset-top="46">
        <van-search
          placeholder="请输入搜索内容"
          @focus="toSearch"
        ></van-search>
      </van-sticky>
      <div style="padding-top: 20px;">
        <van-pull-refresh
          v-model="refreshing"
          @refresh="onRefresh"
        >
          <van-space
            direction="vertical"
            :size="20"
          >
            <div
              v-for="(categoryGroup, index) in categoryGroupList"
              :key="index"
            >
              <van-divider class="divider">{{ categoryGroup.name }}</van-divider>
              <van-grid :border="false" clickable>
                <van-grid-item
                  v-for="category in categoryGroup.childrens"
                  :to="`/products?categoryId=${category.id}`"
                  class="category-grid-item"
                >
                  <van-image
                    round
                    lazy-load
                    :src="category.thumb"
                    :width="60"
                    :height="60"
                  ></van-image>
                  <van-text-ellipsis :content="category.name"></van-text-ellipsis>
                </van-grid-item>
              </van-grid>
            </div>
          </van-space>
        </van-pull-refresh>
      </div>
    </template>
    <!-- 商品分类页 END -->



    <!-- 商品列表页 START -->
    <template id="productListPage">
      <van-sticky :offset-top="46">
        <van-search
          v-model="keyword"
          placeholder="请输入搜索内容"
          @focus="toSearch"
        ></van-search>
      </van-sticky>
      <van-empty
        v-if="!loading && finished && productList.length == 0"
        image="search"
        description="暂无商品"
      >
      </van-empty>
      <van-pull-refresh
        v-else
        v-model="refreshing"
        @refresh="onRefresh"
      >
        <van-list
          v-model:loading="loading"
          :finished="finished"
          :immediate-check="false"
          finished-text="没有更多了"
          @load="onLoad"
        >
          <van-card
            style="margin: 10px; border-radius: 10px;"
            v-for="(product, index) in productList"
            :key="index"
            :title="product.title"
            :desc="product.sub_title"
            :price="Number(product.price * 0.3).toFixed(2)"
            :origin-price="Number(product.price).toFixed(2)"
            :thumb="product.thumb"
            :tag="product.stock == 0 ? '售罄' : ''"
            @click="$router.push(`/products/${product.id}`)"
          >
            <template #bottom>
              <div style="color: var(--van-card-desc-color);">已售 {{ product.sales_count }}</div>
            </template>
            <template #num>
              <van-button
              type="danger"
              size="mini"
              icon="cart-o"
              round
              @click.stop="addCart(product.id)"
            ></van-button>
            </template>
          </van-card>
        </van-list>
      </van-pull-refresh>
      <product-spec-picker
        v-model:show="showSpecPicker"
        :product="currentRecord.product"
        :default-item-ids="currentRecord.selectedItemIds"
        :default-amount="currentRecord.amount"
        button-text="加入购物车"
        @select="selectProductSpec"
      ></product-spec-picker>
    </template>
    <!-- 商品列表页 END -->



    <!-- 搜索页 START -->
    <template id="searchPage">
      <van-sticky :offset-top="46">
        <van-search
          v-model="searchKeyword"
          placeholder="请输入搜索内容"
          ref="search"
          @search="searchHistoryKeyword"
        ></van-search>
      </van-sticky>
      <div style="height: calc(100% - 100px); background-color: #fff;">
        <div
          v-if="historyKeywords.length > 0"
          style="padding: 10px;"
        >
          <van-row style="margin-bottom: 10px;">
            <van-col span="12">
              <span style="font-size: var(--van-font-size-lg); font-weight: var(--van-font-bold);">搜索历史</span>
            </van-col>
            <van-col
              span="12"
              style="text-align: right;"
            >
              <div v-if="deleting">
                <span
                  style="color: var(--van-red);"
                  @click="deleteAllHistoryKeyword"
                >
                  清空
                </span>
                <van-divider vertical></van-divider>
                <span @click="deleting = false">完成</span>
              </div>
              <span
                v-else
                @click="deleting = true"
              >
                管理
              </span>
            </van-col>
          </van-row>
          <van-space>
            <van-tag
              v-for="historyKeyword in historyKeywords"
              :key="historyKeyword"
              :closeable="deleting"
              size="large"
              style="background-color: var(--van-gray-2); color: #666;"
              @click="deleting ? deleteHistoryKeyword(historyKeyword) : searchHistoryKeyword(historyKeyword)"
              @close="deleteHistoryKeyword(historyKeyword)"
            >
              {{ historyKeyword }}
            </van-tag>
          </van-space>
        </div>
      </div>
    </template>
    <!-- 搜索页 END -->



    <!-- 商品详情页 START -->
    <template id="productDetailPage">
      <van-space
        direction="vertical"
        style="width: 100%; padding-bottom: 65px;"
        :size="16"
      >
        <van-swipe
          class="product-swipe"
          :autoplay="3000"
        >
          <van-swipe-item
            v-for="(thumb, index) in product.thumbs"
            :key="index"
            @click="previewImage(index)"
          >
            <img :src="thumb" />
          </van-swipe-item>
        </van-swipe>
        <van-cell-group inset>
          <van-cell>
            <template #title>
              <div>
                <span style="color: var(--van-card-price-color);">
                  ¥ <span style="font-size: 22px;">{{ Number(showPrice * 0.3).toFixed(2) }}</span>
                </span>
                <span class="van-card__origin-price">{{ Number(showPrice).toFixed(2) }}</span>
              </div>
              <div style="font-size: 18px; margin-top: 10px;">
                {{ product.title }}
              </div>
              <div
                v-if="!!product.sub_title"
                style="color: var(--van-card-desc-color); margin-top: 10px;"
              >
                {{ product.sub_title }}
              </div>
            </template>
          </van-cell>
          <van-cell>
            <template #title>
              <van-row>
                <van-col span="12">
                  销量：{{ product.sales_count }}
                </van-col>
                <van-col span="12" style="text-align: right;">
                  库存：{{ showStock }}
                </van-col>
              </van-row>
            </template>
          </van-cell>
        </van-cell-group>
        <van-cell-group inset>
          <van-cell
            :value="`共${optionCount}种规格可选`"
            is-link
            clickable
            @click="showSpecPicker = true"
          >
            <template #title>
              <template v-if="selectedOption">
                已选择 {{ selectedOption.title }} × {{ amount }}
              </template>
              <template v-else>
                请选择
              </template>
            </template>
          </van-cell>
        </van-cell-group>
      </van-space>
      <van-action-bar>
        <van-action-bar-icon
          icon="cart-o"
          text="购物车"
          replace
          to="/cart"
          :badge="$store.getters.totalAmount > 0 ? $store.getters.totalAmount : ''"
        ></van-action-bar-icon>
        <van-action-bar-button
          type="danger"
          @click="showSpecPicker = true"
        >
          加入购物车
        </van-action-bar-button>
      </van-action-bar>
      <product-spec-picker
        v-model:show="showSpecPicker"
        :product="product"
        :default-item-ids="selectedItemIds"
        :default-amount="amount"
        button-text="加入购物车"
        @select="selectProductSpec"
      ></product-spec-picker>
    </template>
    <!-- 商品详情页 END -->



    <!-- 购物车页 START -->
    <template id="cartListPage">
      <van-empty v-if="cartList.length == 0">
        <template #description>
          <div style="text-align: center;">
            购物车为空
            <br />
            赶紧去逛逛，挑选心仪的商品吧
          </div>
        </template>
        <van-button
          plain
          type="danger"
          @click="$router.replace('/')"
        >
          去逛逛
        </van-button>
      </van-empty>
      <div
        v-else
        style="padding-bottom: 50px;"
      >
        <div style="text-align: right; margin: 10px;">
          <span v-if="deleting" @click="deleting = false">完成</span>
          <span v-else @click="deleting = true">编辑</span>
        </div>
        <van-swipe-cell
          v-for="(cartRecord, index) in cartList"
          :key="index"
          :disabled="deleting"
          style="margin: 10px; border-radius: 10px; background-color: var(--van-card-background); overflow: hidden;"
        >
          <div style="display: flex; border-radius: 10px;">
            <van-checkbox
              v-if="deleting"
              :model-value="isCheckedDeleting(cartRecord.id)"
              @update:model-value="(checked) => toggleDeletingCheck(cartRecord.id, checked)"
              style="margin-left: 16px;"
            ></van-checkbox>
            <van-checkbox
              v-else
              :model-value="cartRecord.selected"
              @update:model-value="(checked) => updateSelected(cartRecord.id, checked)"
              style="margin-left: 16px;"
            ></van-checkbox>
            <van-card
              :title="cartRecord.product.title"
              :price="Number(cartRecord.option.price * 0.3).toFixed(2)"
              :origin-price="Number(cartRecord.option.price).toFixed(2)"
              :thumb="cartRecord.product.thumb"
              @click="$router.push(`/products/${cartRecord.product.id}`)"
              lazy-load
              style="flex: 1 1 0; margin: 0;"
            >
              <template #tags>
                <van-tag
                  round
                  style="margin-top: 10px; padding: 3px 6px; background-color: var(--van-gray-2); color: #666;"
                  @click.stop="editProductSpec(cartRecord)"
                >
                  {{ cartRecord.option.title }}
                  <van-icon name="arrow-down"></van-icon>
                </van-tag>
              </template>
              <template #num>
                <van-stepper
                  :default-value="cartRecord.amount"
                  @change="(value) => updateAmount(cartRecord.id, value)"
                  :max="cartRecord.option.stock"
                  @click.stop
                ></van-stepper>
              </template>
            </van-card>
          </div>
          <template #right>
            <van-button
              square
              text="删除"
              type="danger"
              @click="deleteCartRecord(cartRecord.id)"
              style="height: 100%;"
            ></van-button>
          </template>
        </van-swipe-cell>
        <van-submit-bar
          v-if="deleting"
          style="bottom: 50px;"
        >
          <template #default>
            <van-checkbox
              :model-value="isDeletingCheckAll"
              @click="toggleDeletingCheckAll"
            >
              全选
            </van-checkbox>
            <div class="van-submit-bar__text"></div>
          </template>
          <template #button>
            <van-button
              round
              style="width: var(--van-submit-bar-button-width); height: var(--van-submit-bar-button-height); font-weight: var(--van-font-bold);"
              @click="deleteChecked"
            >
              删除
            </van-button>
          </template>
        </van-submit-bar>
        <van-submit-bar
          v-else
          :price="$store.getters.totalPrice * 30"
          :button-text="`生成订单(${$store.getters.totalSelectedAmount})`"
          style="bottom: 50px;"
          @submit="exportOrder"
        >
          <template #default>
            <van-checkbox
              :model-value="isCheckAll"
              @click="toggleCartCheckAll"
            >
              全选
            </van-checkbox>
          </template>
        </van-submit-bar>
        <product-spec-picker
          v-model:show="showSpecPicker"
          :product="editingCartRecord.product"
          :default-item-ids="editingCartRecord.selectedItemIds"
          :default-amount="editingCartRecord.amount"
          button-text="确认"
          @select="selectProductSpec"
        ></product-spec-picker>
      </div>
    </template>
    <!-- 购物车页 END -->



    <!-- 商品规格选择器组件 START -->
    <template id="productSpecPickerComponent">
      <van-popup
        :show="show"
        :style="{ height: '80%' }"
        closeable
        position="bottom"
        @close="onClose"
      >
        <div style="height: 100%; overflow-y: auto; padding: 20px 10px 70px 10px; box-sizing: border-box;">
          <van-space
            direction="vertical"
            style="width: 100%;"
            :size="20"
          >
            <div style="display: flex;">
              <van-image
                width="100"
                height="100"
                radius="10"
                :src="product.thumb"
              ></van-image>
              <div style="margin-left: 15px;">
                <div>
                  <span style="color: var(--van-card-price-color);">
                    ¥ <span style="font-size: var(--van-font-size-lg);">{{ Number(filteredOptionPrice * 0.3).toFixed(2) }}</span>
                  </span>
                  <span class="van-card__origin-price">{{ Number(filteredOptionPrice).toFixed(2) }}</span>
                </div>
                <div style="color: var(--van-card-desc-color); margin-top: 15px; margin-bottom: 15px;">
                  库存 {{ filteredOptionStock }} 件
                </div>
                <van-stepper
                  v-model="amount"
                  :max="filteredOptionStock"
                ></van-stepper>
              </div>
            </div>
            <template v-for="(spec, index) in product.specs" :key="index">
              <div>
                <div style="margin-bottom: 10px; font-weight: var(--van-font-bold);">{{ spec.title }}</div>
                <van-space wrap>
                  <van-tag
                    v-for="item in spec.items"
                    type="danger"
                    size="large"
                    round
                    :plain="isSelectedItemId(item.id)"
                    style="padding: 6px 12px; cursor: pointer;"
                    :style="isDisabledItemId(item.id)
                      ? { backgroundColor: 'var(--van-gray-2)', color: '#ccc' }
                      : (isSelectedItemId(item.id) ? { backgroundColor: '#ffe1e1' } : { backgroundColor: 'var(--van-gray-2)', color: '#666' })"
                    @click="toggleSelectItemId(item.id)"
                  >
                    {{ item.title }}
                  </van-tag>
                </van-space>
              </div>
            </template>
          </van-space>
        </div>
        <van-action-bar>
          <van-action-bar-button
            type="danger"
            @click="onConfirm"
          >
            {{ buttonText }}
          </van-action-bar-button>
        </van-action-bar>
      </van-popup>
    </template>
    <!-- 商品规格选择器组件 END -->



    <div id="app">
      <div
        id="container"
        :style="{
          paddingBottom: $route.meta.showTabBar ? '60px' : '0',
          boxSizing: 'border-box',
          overflowY: 'auto'
        }"
      >
        <van-sticky>
          <van-nav-bar
            v-if="!!$route.meta.pageTitle"
            :title="$route.meta.pageTitle"
            :left-arrow="$route.meta.pageBack"
            @click-left="backPage"
          ></van-nav-bar>
        </van-sticky>
        <router-view></router-view>
      </div>
      <van-tabbar
        v-if="$route.meta.showTabBar"
        route
      >
        <van-tabbar-item
          replace
          to="/"
          name="home"
          icon="home-o"
        >
          首页
        </van-tabbar-item>
        <van-tabbar-item
          replace
          to="/cart"
          name="cart"
          icon="cart-o"
          :badge="$store.getters.totalAmount > 0 ? $store.getters.totalAmount : ''"
        >
          购物车
        </van-tabbar-item>
      </van-tabbar>
      <van-back-top
        v-if="$route.meta.showBackTop"
        bottom="80"
      ></van-back-top>
    </div>

    <script src="https://unpkg.com/axios@1.7.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3.5.6/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vant@4.9.6/lib/vant.min.js"></script>
    <script src="https://unpkg.com/vue-router@4.4.5/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/vuex@4.1.0/dist/vuex.global.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.js"></script>
    <script src="https://unpkg.com/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
      const request = axios.create({
        baseURL: 'https://cs.sdxpos.com/shop/client/goods',
        headers: {
          'session-id': 123,
          'client-type': 'wxapp',
          'shop-id': 1162,
        }
      });



      // 商品分类页
      const categoryListPage = {
        template: '#categoryListPage',
        data() {
          return {
            refreshing: false,
            categoryGroupList: []
          }
        },
        created() {
          this.getCategoryList(); 
        },
        methods: {
          getCategoryList() {
            request.get('/category/list?child_shop_id=')
              .then(response => {
                this.refreshing = false;
                this.categoryGroupList = response.data.data;
              });
          },
          onRefresh() {
            this.getCategoryList();
          },
          toSearch() {
            this.$router.replace(`/search`);
          }
        }
      };



      // 搜索页
      const searchPage = {
        template: '#searchPage',
        props: {
          keyword: {
            type: String,
            default: ''
          }
        },
        data() {
          const historyKeywords = JSON.parse(window.localStorage.getItem('historyKeywords'));
          return {
            historyKeywords: _.isArray(historyKeywords) ? historyKeywords : [],
            searchKeyword: '',
            deleting: false
          }
        },
        watch: {
          historyKeywords: {
            handler(value) {
              localStorage.setItem('historyKeywords', JSON.stringify(value))
            },
            deep: true
          }
        },
        mounted() {
          this.$watch(
            () => this.$route,
            () => {
              this.$refs.search.focus();
              this.searchKeyword = this.keyword;
              this.$nextTick(() => {
                const searchInput = this.$refs.search.$el.querySelector('input');
                if (searchInput) {
                  searchInput.setSelectionRange(-1, -1);
                }
              })
            },
            { immediate: true }
          )
        },
        methods: {
          searchHistoryKeyword(value) {
            this.addHistoryKeyword(value);
            this.$router.replace(`/products?keyword=${value}`);
          },
          addHistoryKeyword(historyKeyword) {
            if (historyKeyword === '') {
              return;
            }
            this.historyKeywords = _.take(_.concat([historyKeyword], _.without(this.historyKeywords, historyKeyword)), 20);
          },
          deleteHistoryKeyword(historyKeyword) {
            if (historyKeyword === '') {
              return;
            }
            this.historyKeywords = _.without(this.historyKeywords, historyKeyword);
          },
          deleteAllHistoryKeyword() {
            this.historyKeywords = [];
          }
        }
      };



      // 商品列表页
      const productListPage = {
        template: '#productListPage',
        props: {
          categoryId: {
            type: Number,
            default: 0
          },
          keyword: {
            type: String,
            default: ''
          }
        },
        data() {
          return {
            refreshing: false,
            loading: false,
            finished: false,
            page: 1,
            productList: [],
            showSpecPicker: false,
            currentRecord: {
              product: {},
              amount: 1,
              option_id: 0,
              option: {},
              selectedItemIds: []
            }
          };
        },
        created() {
          this.$watch(
            () => this.$route,
            () => {
              this.refreshing = false;
              this.finished = false;
              this.loading = true;
              this.page = 1;
              this.productList = [];
              this.showSpecPicker = false;
              this.onLoad();
            },
            { immediate: true }
          );
        },
        methods: {
          onLoad() {
            request.get(`/list?title=${this.keyword}&category_ids=${this.categoryId}&group_ids=&page=${this.page}&page_size=20&sort=&by=desc&lat=&lng=&coupon_id=&dycoupon_id=&from_dycoupon_list=&activity_id=&child_shop_id=&type=&recommend=`)
              .then(response => {
                if (this.refreshing) {
                  this.refreshing = false;
                  this.productList = [];
                }
                this.productList = this.productList.concat(response.data.list);
                this.loading = false;
                if (this.page >= response.data.pageCount) {
                  this.finished = true;
                } else {
                  this.page++;
                }
              });
          },
          onRefresh() {
            this.finished = false;
            this.loading = true;
            this.page = 1;
            this.onLoad();
          },
          toSearch() {
            this.$router.replace(this.keyword ? `/search?keyword=${this.keyword}` : '/search');
          },
          addCart(productId) {
            request.get(`/details-new?id=${productId}&activity_id=undefined`)
              .then(response => {
                this.showSpecPicker = true;
                this.currentRecord = {
                  product: this.convertProduct(response.data.data),
                  amount: 1,
                  option_id: 0,
                  option: {},
                  selectedItemIds: []
                };
              });
          },
          convertProduct(rawProduct) {
            return {
              id: Number(rawProduct.id),
              title: rawProduct.title,
              sub_title: rawProduct.sub_title,
              thumb: rawProduct.thumb,
              thumbs: rawProduct.thumbs,
              sales_count: Number(rawProduct.sales_count),
              specs: _.map(rawProduct.specs, spec => ({
                id: Number(spec.id),
                title: spec.title,
                items: _.map(spec.items, item => ({
                  id: Number(item.id),
                  title: item.title,
                }))
              })),
              options: _.map(_.values(rawProduct.options), option => {
                return {
                  id: Number(option.id),
                  stock: Number(option.stock),
                  price: Number(option.price),
                  item_ids: _.map(_.sortBy(option.specs.split(',')), itemId => Number(itemId)),
                  title: option.option_title.join(','),
                };
              })
            };
          },
          selectProductSpec(itemIds, amount, confirm) {
            if (!confirm) {
              return;
            }
            this.currentRecord.selectedItemIds = itemIds;
            this.currentRecord.amount = amount;
            if (this.currentRecord.selectedItemIds.length === 0 || this.currentRecord.selectedItemIds.length !== this.currentRecord.product.specs.length) {
              vant.showToast('请选择完整规格');
              return;
            }
            const selectedOption = _.find(this.currentRecord.product.options, option => _.isEqual(_.sortBy(option.item_ids), _.sortBy(this.currentRecord.selectedItemIds)));
            if (this.currentRecord.amount > selectedOption.stock) {
              vant.showToast('库存不足');
              return;
            }
            this.$store.dispatch('addCartRecord', {
              product: this.currentRecord.product,
              option_id: selectedOption.id,
              amount: this.currentRecord.amount
            });
            vant.showSuccessToast('加购成功');
          }
        }
      };



      // 商品详情页
      const productDetailPage = {
        template: '#productDetailPage',
        props: {
          productId: {
            type: Number,
            default: 0
          }
        },
        data() {
          return {
            loading: false,
            product: {
              id: 0,
              title: '',
              price: [0],
              min_price: '',
              max_price: '',
              thumbs: [],
              specs: [],
              options: []
            },
            amount: 1,
            selectedItemIds: [],
            showSpecPicker: false
          };
        },
        created() {
          this.$watch(
            () => this.$route,
            () => {
              this.amount = 1;
              this.selectedItemIds = [];
              this.showSpecPicker = false;
              this.getProduct();
            },
            { immediate: true }
          );
        },
        computed: {
          optionCount() {
            return this.product.options.length;
          },
          showPrice() {
            return this.product.options.length === 0 ? 0 : _.min(_.map(this.product.options, 'price'));
          },
          showStock() {
            return this.product.options.length === 0 ? 0 : _.sum(_.map(this.product.options, 'stock'));
          },
          selectedOption() {
            if (this.selectedItemIds.length === 0 || this.selectedItemIds.length !== this.product.specs.length) {
              return;
            }
            return _.find(this.product.options, option => _.isEqual(_.sortBy(option.item_ids), _.sortBy(this.selectedItemIds)));
          }
        },
        methods: {
          getProduct() {
            this.loading = true;
            request.get(`/details-new?id=${this.productId}&activity_id=undefined`)
              .then(response => {
                this.loading = false;
                this.product = this.convertProduct(response.data.data);
              });
          },
          convertProduct(rawProduct) {
            return {
              id: Number(rawProduct.id),
              title: rawProduct.title,
              sub_title: rawProduct.sub_title,
              thumb: rawProduct.thumb,
              thumbs: rawProduct.thumbs,
              sales_count: Number(rawProduct.sales_count),
              specs: _.map(rawProduct.specs, spec => ({
                id: Number(spec.id),
                title: spec.title,
                items: _.map(spec.items, item => ({
                  id: Number(item.id),
                  title: item.title,
                }))
              })),
              options: _.map(_.values(rawProduct.options), option => {
                return {
                  id: Number(option.id),
                  stock: Number(option.stock),
                  price: Number(option.price),
                  item_ids: _.map(_.sortBy(option.specs.split(',')), itemId => Number(itemId)),
                  title: option.option_title.join(','),
                };
              })
            };
          },
          previewImage(startPosition) {
            vant.showImagePreview({
              images: this.product.thumbs,
              startPosition: startPosition,
              closeable: true
            });
          },
          selectProductSpec(itemIds, amount, confirm) {
            this.selectedItemIds = itemIds;
            this.amount = amount;
            if (confirm) {
              this.$store.dispatch('addCartRecord', {
                product: this.product,
                option_id: this.selectedOption.id,
                amount: this.amount
              });
              vant.showSuccessToast('加购成功');
            }
          }
        }
      };



      // 购物车页
      const cartListPage = {
        template: '#cartListPage',
        data() {
          return {
            deleting: false,
            deletingIds: [],
            showSpecPicker: false,
            editingCartRecord: {
              product: {},
              amount: 1,
              option_id: 0,
              option: {},
              selectedItemIds: []
            },
          };
        },
        computed: {
          cartList() {
            const rawCartList = this.$store.state.cartList;
            return _.map(rawCartList, item => {
              item.option = _.find(item.product.options, option => option.id === item.option_id);
              return item;
            });
          },
          isCheckAll() {
            return _.every(this.cartList, item => item.selected);
          },
          isDeletingCheckAll() {
            return _.isEqual(_.sortBy(this.deletingIds), _.sortBy(_.map(this.cartList, 'id')));
          }
        },
        methods: {
          enterDeleting() {
            this.deleting = true;
            this.deletingIds = [];
          },
          isCheckedDeleting(id) {
            return _.includes(this.deletingIds, id);
          },
          toggleDeletingCheckAll() {
            this.deletingIds = this.isDeletingCheckAll ? [] : _.map(this.cartList, 'id');
          },
          toggleDeletingCheck(id, checked) {
            this.deletingIds = checked ? _.concat(this.deletingIds, id) : _.without(this.deletingIds, id);
          },
          deleteChecked() {
            if (this.deletingIds.length === 0) {
              return;
            }
            _.forEach(this.deletingIds, id => {
              this.$store.dispatch('deleteCartRecord', id);
            });
          },
          toggleCartCheckAll() {
            this.$store.dispatch('toggleCartCheckAll', !this.isCheckAll);
          },
          deleteCartRecord(id) {
            this.$store.dispatch('deleteCartRecord', id);
          },
          updateAmount(id, amount) {
            this.$store.dispatch('updateCartRecord', {
              id: id,
              amount: amount,
            });
          },
          updateSelected(id, selected) {
            this.$store.dispatch('updateCartRecord', {
              id: id,
              selected: selected,
            });
          },
          editProductSpec(cartRecord) {
            this.editingCartRecord = cartRecord;
            this.editingCartRecord.selectedItemIds = cartRecord.option.item_ids;
            this.showSpecPicker = true;
          },
          selectProductSpec(selectedItemIds, amount, confirm) {
            if (!confirm) {
              return;
            }
            this.editingCartRecord.selectedItemIds = selectedItemIds;
            this.editingCartRecord.amount = amount;
            if (this.editingCartRecord.selectedItemIds.length === 0 || this.editingCartRecord.selectedItemIds.length !== this.editingCartRecord.product.specs.length) {
              vant.showToast('请选择完整规格');
              return;
            }
            const selectedOption = _.find(this.editingCartRecord.product.options, option => _.isEqual(_.sortBy(option.item_ids), _.sortBy(this.editingCartRecord.selectedItemIds)));
            if (this.editingCartRecord.amount > selectedOption.stock) {
              vant.showToast('库存不足');
              return;
            }
            this.$store.dispatch('updateCartRecord', {
              id: this.editingCartRecord.id,
              amount: this.editingCartRecord.amount,
              option_id: selectedOption.id,
            });
            vant.showSuccessToast('修改成功');
          },
          async getBufferFromImageUrls(urls) {
            const promises = _.map(urls, url => axios.get(url, {
              responseType: 'arraybuffer',
            }));
            const results = await Promise.all(promises);
            return results.map(result => result.data);
          },
          async exportOrder() {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('订单', {views:[{state: 'frozen', xSplit: 1, ySplit:1}]});
            worksheet.columns = [
              {
                header: '预览图',
                key: 'thumb',
                width: 30,
              },
              {
                header: '名称',
                key: 'title',
                width: 30,
              },
              {
                header: '规格',
                key: 'spec',
                width: 20,
              },
              {
                header: '单价（原价）',
                key: 'original_price',
                width: 20,
              },
              {
                header: '单价（折后价）',
                key: 'price',
                width: 20,
              },
              {
                header: '数量',
                key: 'amount',
                width: 10,
              }
            ];
            const selectedCartList = _.filter(this.cartList, cartRecord => cartRecord.selected);
            _.forEach(selectedCartList, cartRecord => {
              const row = worksheet.addRow([
                '',
                cartRecord.product.title,
                cartRecord.option.title,
                Number(cartRecord.option.price).toFixed(2),
                Number(cartRecord.option.price * 0.3).toFixed(2),
                cartRecord.amount,
              ]);
              row.height = 200;
            });
            const buffers = await this.getBufferFromImageUrls(_.map(selectedCartList, cartRecord => cartRecord.product.thumb));
            _.forEach(buffers, (buffer, index) => {
              const imageId = workbook.addImage({
                buffer: buffer,
              });
              worksheet.addImage(imageId, {
                tl: { col: 0, row: index + 1 },
                br: { col: 1, row: index + 2 },
                editAs: 'undefined',
              });
            });
            workbook.xlsx.writeBuffer().then((buffer) => {
              const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              saveAs(blob, '订单.xlsx');
            });
          }
        }
      };



      // 商品规格选择器
      const productSpecPickerComponent = {
        template: '#productSpecPickerComponent',
        props: {
          show: {
            type: Boolean,
            default: false
          },
          product: {
            type: Object,
            default: {}
          },
          defaultItemIds: {
            type: Array,
            default: []
          },
          defaultAmount: {
            type: Number,
            default: 0
          },
          buttonText: {
            type: String,
            default: '确定'
          }
        },
        emits: ['update:show', 'select'],
        data() {
          return {
            selectedItemIds: [],
            amount: 1
          }
        },
        watch: {
          defaultItemIds: {
            handler(itemIds) {
              this.selectedItemIds = itemIds;
            },
            immediate: true
          },
          defaultAmount: {
            handler(amount) {
              this.amount = amount;
            },
            immediate: true
          }
        },
        computed: {
          allItems() {
            return _.flatten(_.map(this.product.specs, spec => {
              return _.map(spec.items, item => {
                item.spec_id = spec.id;
                return item;
              });
            }));
          },
          filteredOptionPrice() {
            const filteredOptions = this.filteredOptions(this.selectedItemIds);
            return filteredOptions.length === 0 ? 0 : _.min(_.map(filteredOptions, 'price'));
          },
          filteredOptionStock() {
            const filteredOptions = this.filteredOptions(this.selectedItemIds);
            return filteredOptions.length === 0 ? 0 : _.sum(_.map(filteredOptions, 'stock'));
          }
        },
        methods: {
          filteredOptions(itemIds) {
            let filteredOptions = this.product.options;
            for (var i = 0; i < itemIds.length; i++) {
              filteredOptions = _.filter(filteredOptions, option => _.includes(option.item_ids, itemIds[i]));
            }
            return filteredOptions;
          },
          getSpecIdByItemId(itemId) {
            return _.find(this.allItems, item => item.id == itemId).spec_id;
          },
          getItemIdsBySpecId(specId) {
            return _.map(_.filter(this.allItems, item => item.spec_id == specId), 'id');
          },
          isDisabledItemId(itemId) {
            const sameSpecItemIds = this.getItemIdsBySpecId(this.getSpecIdByItemId(itemId));
            const itemIds = _.concat(_.filter(this.selectedItemIds, itemId => !_.includes(sameSpecItemIds, itemId)), itemId);
            const filteredOptions = this.filteredOptions(itemIds);
            return !_.some(filteredOptions, option => option.stock != 0);
          },
          isSelectedItemId(itemId) {
            return _.includes(this.selectedItemIds, itemId);
          },
          toggleSelectItemId(itemId) {
            if (_.includes(this.selectedItemIds, itemId)) {
              this.selectedItemIds = _.without(this.selectedItemIds, itemId);
            } else {
              if (this.isDisabledItemId(itemId)) {
                return;
              }
              const sameSpecItemIds = this.getItemIdsBySpecId(this.getSpecIdByItemId(itemId));
              this.selectedItemIds = _.concat(_.without(this.selectedItemIds, ...sameSpecItemIds), itemId);
            }
          },
          onClose() {
            this.$emit('select', this.selectedItemIds, this.amount, false);
            this.$emit('update:show', false);
          },
          onConfirm() {
            if (this.selectedItemIds.length === 0 || this.selectedItemIds.length != this.product.specs.length) {
              vant.showToast('请选择完整规格');
              return;
            }
            const selectedOption = _.find(this.product.options, option => _.isEqual(_.sortBy(option.item_ids), _.sortBy(this.selectedItemIds)));
            if (this.amount > selectedOption.stock) {
              vant.showToast('库存不足');
              return;
            }
            this.$emit('select', this.selectedItemIds, this.amount, true);
            this.$emit('update:show', false);
          }
        }
      };



      // 路由管理
      const router = VueRouter.createRouter({
        history: VueRouter.createWebHashHistory(),
        routes: [
          {
            path: '/',
            component: categoryListPage,
            meta: {
              pageTitle: '首页',
              pageBack: false,
              showTabBar: true,
              showBackTop: true,
            }
          },
          {
            path: '/search',
            component: searchPage,
            props: route => ({ keyword: route.query.keyword || '' }),
            meta: {
              pageTitle: '搜索',
              pageBack: true,
              showTabBar: false,
              showBackTop: false,
            }
          },
          {
            path: '/products',
            component: productListPage,
            props: route => ({ categoryId: Number(route.query.categoryId || 0), keyword: route.query.keyword || '' }),
            meta: {
              pageTitle: '商品列表',
              pageBack: true,
              showTabBar: false,
              showBackTop: true,
            }
          },
          {
            path: '/products/:productId',
            component: productDetailPage,
            props: route => ({ productId: Number(route.params.productId) }),
            meta: {
              pageTitle: '商品详情',
              pageBack: true,
              showTabBar: false,
              showBackTop: false,
            }
          },
          {
            path: '/cart',
            component: cartListPage,
            meta: {
              pageTitle: '购物车',
              pageBack: false,
              showTabBar: true,
              showBackTop: false,
            }
          },
        ]
      });


      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0, v = c === 'x'? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
      // 状态管理
      const store = Vuex.createStore({
        state () {
          const cartList = JSON.parse(localStorage.getItem('cartList') || '[]')
          return {
            cartList: cartList
          };
        },
        getters: {
          totalAmount(state) {
            return _.sum(_.map(state.cartList, item => Number(item.amount)));
          },
          totalSelectedAmount(state) {
            return _.sum(_.map(state.cartList, item => item.selected ? Number(item.amount) : 0));
          },
          totalPrice(state) {
            return _.sum(_.map(state.cartList, item => {
              if (!item.selected) {
                return 0;
              }
              const option = _.find(item.product.options, option => option.id === item.option_id);
              return Number(item.amount) * Number(option.price);
            }));
          },
        },
        mutations: {
          toggleCartCheckAll(state, selected) {
            state.cartList = _.map(state.cartList, item => {
              item.selected = selected;
              return item;
            });
          },
          addCartRecord(state, cartRecord) {
            if (!cartRecord.amount) {
              return;
            }
            const record = state.cartList.find(item => item.option_id === cartRecord.option_id);
            if (record) {
              if (typeof cartRecord.product !== 'undefined') {
                record.product = cartRecord.product;
              }
              record.amount += cartRecord.amount;
            } else {
              cartRecord.id = generateUUID();
              cartRecord.selected = true;
              state.cartList.push(cartRecord);
            }
          },
          deleteCartRecord(state, id) {
            state.cartList = _.filter(state.cartList, item => item.id != id);
          },
          updateCartRecord(state, updateData) {
            if (!updateData.id) {
              return;
            }
            const record = state.cartList.find(item => item.id === updateData.id);
            if (!record) {
              return;
            }
            if (typeof updateData.product !== 'undefined') {
              record.product = updateData.product;
            }
            if (typeof updateData.option_id !== 'undefined') {
              record.option_id = updateData.option_id;
            }
            if (typeof updateData.amount !== 'undefined') {
              record.amount = updateData.amount;
            }
            if (typeof updateData.selected !== 'undefined') {
              record.selected = updateData.selected;
            }
          },
        },
        actions: {
          toggleCartCheckAll({ commit }, selected) {
            commit('toggleCartCheckAll', selected);
            localStorage.setItem('cartList', JSON.stringify(this.state.cartList));
          },
          addCartRecord({ commit }, cartRecord) {
            commit('addCartRecord', cartRecord);
            localStorage.setItem('cartList', JSON.stringify(this.state.cartList));
          },
          deleteCartRecord({ commit }, id) {
            commit('deleteCartRecord', id);
            localStorage.setItem('cartList', JSON.stringify(this.state.cartList));
          },
          updateCartRecord({ commit }, cartRecord) {
            commit('updateCartRecord', cartRecord);
            localStorage.setItem('cartList', JSON.stringify(this.state.cartList));
          },
        }
      });



      const app = Vue.createApp({
          data() {
            return {};
          },
          methods: {
            backPage() {
              if (this.$router.options.history.state) {
                this.$router.back();
              } else {
                this.$router.push('/');
              }
            }
          }
        })
        .use(vant)
        .use(vant.Lazyload, { lazyComponent: true })
        .use(router)
        .use(store)
        .component('productSpecPicker', productSpecPickerComponent)
        .mount("#app");
    </script>
  </body>
</html>
